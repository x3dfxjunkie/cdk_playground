stack_extension: &se test
ingest_pattern: &ip dms
active: True
feature_branch: False
pattern_instances:
  - region: &region-1 us-east-1
    resources:
      dms_repl_instance:
        name: &dn test
        instance_class: dms.r5.xlarge
        storage: 100
        engine_version: "3.4.7"
        auto_minor_version_upgrade: True
        allow_major_version_upgrade: True
        multi_az: False
        maint_window: Mon:00:00-Mon:01:00
        instance_identifier: test-inst
        security_group_ids:
        subnet_props:
          group_name: test-subnet-group
          description: subnet group for test DMS
          subnet_identifer: test-subnet
          subnet_list:
            - subnet-0a28c8fdd2b6b3bdf
      source_endpoint:
        endpoint_type: source
        engine_name: mariadb
        ssl_mode: verify-ca
        settings:
          server_timezone: US/Eastern
          events_poll_interval: 5
          clean_source_metadata_on_mismatch: False
          secrets_manager_access_role_arn: arn_placeholder #pragma: allowlist secret
          secrets_manager_secret_id: arn:aws:secretsmanager:us-east-1:543276908693:secret:lst-use1-xxxxxx #pragma: allowlist secret
        database_name:
      source_kms_key: f43a2a74-a868-43c2-xxxx-xxxxxxxxxxxx
      #source_ssl_cert: rds-global-bundle 
      dms_repl_task:
        - &replication_task_definitions
          replication_task_identifier: full1
          source_endpoint_arn: source_arn
          target_endpoint_arn: target_arn
          replication_instance_arn: instance_arn
          replication_task_settings: '{"Logging": {"EnableLogging": true}}'
          migration_type: full-load
          table_mappings:
            rules:
              - rule-type: selection
                rule-id: "1"
                rule-name: "1"
                rule-action: include
                object-locator:
                  schema-name: "awakening"
                  table-name: "%"
      stack_extension: *se
      event_bridge_pipe_validation:
        name: test-event-bridge-pipe-validation
        role_arn:
        pipe_source_parameters: # Event Bridge Pipe source settings
          kinesis_stream_parameters:
            startingPosition: "TRIM_HORIZON"
            batchSize: 100
            maximumRetryAttempts: 3
            parallelizationFactor: 3
            deadLetterConfig:
              arn:                    
          sqs_queue_parameters:
        pipe_target_parameters:
          kinesis_stream_parameters:
            partitionKey: $.partition_key
          lambda_function_parameters:
      event_bridge_pipe_dead_letter_queue:
        name: test-event-bridge-pipe-dlq
        role_arn:
        pipe_source_parameters:
          sqs_queue_parameters:
        pipe_target_parameters:
          lambda_function_parameters:
      lambda_validator:
        function_name: test-lambda-validator
        handler: runner.lambda_handler
        timeout: !!python/object/apply:app.src.reliability.Guest360YamlHandler.aws_cdk.duration.Duration 
          - seconds
          - 60
        code: bazel-bin/app/src/ingestion/event_pipes/validation/data_contract_lambda_validator.zip
        enable_otel_tracing: True
      lambda_dead_letter:
        function_name: test-lambda-dead-letter-processor
        handler: runner.lambda_handler
        code: bazel-bin/app/src/ingestion/event_pipes/dead_letter/data_contract_lambda_dead_letter.zip
        timeout: !!python/object/apply:app.src.reliability.Guest360YamlHandler.aws_cdk.duration.Duration
          - seconds
          - 60
        enable_otel_tracing: True
      app_config:
        deployment:
          configuration_version: "1"
        hosted_configuration:
            content:
      sqs: &sqs
        queue_name: &sqs_queue_name test-sqs-dead-letter
        encryption_key: NULL
      kinesis_dmz: &kinesis_dmz
        stream_name: &dmz_stream_name test-kinesis-dmz
        retention_period: &kdr_dmz !!python/object/apply:app.src.reliability.Guest360YamlHandler.aws_cdk.aws_kinesis.days_retention
          - 14
        stream_mode: &ksm_dmz !!python/object/apply:aws_cdk.aws_kinesis.StreamMode
          - PROVISIONED
        shard_count: &ksc_dmz 1
        encryption_key: NULL
      kinesis: &kinesis
        stream_name: &stream_name test-kinesis
        retention_period: &kdr !!python/object/apply:app.src.reliability.Guest360YamlHandler.aws_cdk.aws_kinesis.days_retention 
          - 14
        stream_mode: &ksm !!python/object/apply:aws_cdk.aws_kinesis.StreamMode
          - PROVISIONED
        shard_count: &ksc 1
        encryption_key: NULL
      kinesis_firehose:
        enabled: False
        bucket_name: raw
        buffering_hints:
          interval: 60
          unit_of_time: SECONDS
        partitioning:
          dynamic:
            enabled: True
            keys: NULL
          custom_keys: NULL
      source_iam:
        role_name: source-endpoint-test
        assumed_by: !!python/object/apply:aws_cdk.aws_iam.ServicePrincipal
          - dms.us-east-1.amazonaws.com
        description: IAM Role to be used for the secrets manager for test mariadb
      target_iam:
        role_name: target-endpoint-test
        assumed_by: !!python/object/apply:aws_cdk.aws_iam.ServicePrincipal
          - dms.amazonaws.com
        description: IAM Role to be used for the DMS kinesis target endpoint for test
      target_endpoint:
        endpoint_type: target
        engine_name: kinesis
        settings:
          include_control_details: False
          include_null_and_empty: False
          include_partition_value: False
          include_table_alter_operations: False
          include_transaction_details: False
          message_format: JSON
          no_hex_prefix: False
          partition_include_schema_table: False 
      networking:
        allowlist:
          egress:
            cidrs:
              - "0.0.0.0/0"
            ports:
              - 443
          local_egress:
            cidr:
              "10.0.0.0/8"
    data_pipe:
      default_router_database: DEFAULT_ROUTER_LATEST_LANDING # Needs update to appropriate default routing
      data_contracts: # This section needs to be updated for all data contracts for the source
        - data_contract: app.src.data_structures.data_contracts.source.cme_dlr.v0.cme_dlr_inventory_product_source_data_contract
          class_name: CMEDLRInventoryProductModel
          data_contract_version: 0.0.1
          key_path:
            - name: metadata.table-name
              value: inventory_product
          router_database: LATEST_LANDING
          router_schema: LND_CME_DLR
          router_table: INVENTORY_PRODUCT