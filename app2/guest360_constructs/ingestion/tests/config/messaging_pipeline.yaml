stack_extension: &se stack-name
ingest_pattern: &ip messaging
active: True
pattern_instances:
  - region: &region-1 us-east-1
    resources:
      cluster_name: &rcm cluster-name
      stack_extension: *se
      kinesis: &kinesis
        stream_name: &stream_name kinesis-stream-name-test
        retention_period: &kdr !!python/object/apply:app.src.reliability.Guest360YamlHandler.aws_cdk.aws_kinesis.days_retention
          - 14
        stream_mode: &ksm !!python/object/apply:aws_cdk.aws_kinesis.StreamMode
          - PROVISIONED
        shard_count: &ksc 1
        encryption_key: NULL
      kinesis_dmz: &kinesis_dmz
        stream_name: &dmz_stream_name test-kinesis-dmz
        retention_period: &kdr_dmz !!python/object/apply:app.src.reliability.Guest360YamlHandler.aws_cdk.aws_kinesis.days_retention
          - 14
        stream_mode: &ksm_dmz !!python/object/apply:aws_cdk.aws_kinesis.StreamMode
          - PROVISIONED
        shard_count: &ksc_dmz 1
        encryption_key: NULL
      kinesis_firehose:
        enabled: True
        bucket_name: test
        buffering_hints:
          interval: 60
          unit_of_time: SECONDS
        partitioning:
          dynamic:
            enabled: True
            keys: NULL
          custom_keys: NULL
      ecs:
        region: *region-1
        memory_mib: 2048
        cpu_limitmb: 1024
        networking:
          vpc_id: vpc-02da7a04db8bee27b
          is_default: False
          allowlist:
            ingress:
              cidrs: &cidr
                - "10.0.0.0/8"
              ports:
                - 443
            egress:
              cidr: *cidr
              ports:
                - -1

          blocklist:
            ingress:
              cidrs:
                - NULL
              ports:
                - NULL
        ecr:
          repository_name: lst-use1-repository
        secret_name: &secret_name secret-test
        iam: &iam
          role_name: ecs-consumer-role-test
          assumed_by: !!python/object/apply:aws_cdk.aws_iam.ServicePrincipal
            - ecs-tasks.amazonaws.com
          description: IAM Role to be used by the ECS consumer
        s3:
          bucket_name: *rcm
        services:
          - service_name: DLR-AFFIL-AFFILIATION-GUEST360              # Max lenght 34 characters due construct prefixes
            image_tag: &image rabbitmq_consumer1.0.0
            desired_count : 1
            cloudmap: False
            environment: &environment
              ENVIRONMENT :  latest                                   # Required: Yes , Default Value = “” ,Environment value (latest,stage,prod)
              KINESIS_STREAM :  *stream_name                          # Required: Yes , Default Value = “”, Kinesis stream name
              FAILED_MSG_BUCKET_NAME : latest-fail-test          # Required: Yes , S3 bucket name to store records after exhausting max retry attempt
              FAILED_MSG_BUCKET_PATH : /TEST/   # Required: Yes , Default Value = no have, “/”
              MAX_RETRY_ATTEMPT :   3                                 # Required: Yes , Default Value =  3  Number of attempts to send record to kinesis before writing to failed records S3 bucket
              RABBITMQ_SECRET_PATH : *secret_name                     # Required: Yes , Secret manager secret path. value is prepended to this path value by connector code , “Secretname”
              RABBITMQ_HOST :   host_name # Required: Yes , Default Value = “localhost”  RabbitMQ server host name or IP address
              RABBITMQ_QUEUE :   QUEUE_NAME           # Required: Yes , RabbitMQ queue name
              USE_SSL: True
          - service_name: DLR-GAM-TICKETS-GUEST360
            image_tag: *image
            desired_count : 1
            cloudmap: False
            environment:
              <<: *environment
              FAILED_MSG_BUCKET_PATH : /GAM-TICKETS-GUEST360/
              RABBITMQ_QUEUE :   GAM.TICKETS.GUEST360
              RABBITMQ_ROUTING_KEY :  AFFIL.AFFIL.X
              RABBITMQ_EXCHANGE :   AFFIL.AFFILIATION.XI
      event_bridge_pipe_validation:
        name: test-event-bridge-pipe-validation
        role_arn:
        pipe_source_parameters:
          kinesis_stream_parameters:
            startingPosition: "LATEST"
            batchSize: 100
            maximumRetryAttempts: 3
            parallelizationFactor: 3
            deadLetterConfig: 
              arn:                    
          sqs_queue_parameters: 
        pipe_target_parameters:
          kinesis_stream_parameters:
            partitionKey: $.partition_key
          lambda_function_parameters:
      event_bridge_pipe_dead_letter_queue:
        name: test-event-bridge-pipe-dlq
        role_arn: 
        pipe_source_parameters:
          sqs_queue_parameters:
        pipe_target_parameters:
          lambda_function_parameters:
      lambda_validator:
        function_name: test-lambda-validator
        handler: runner.lambda_handler
        code: bazel-bin/app/src/ingestion/event_pipes/validation/data_contract_lambda_validator.zip
        enable_otel_tracing: False
      lambda_dead_letter:
        function_name: test-lambda-dead-letter-processor
        handler: runner.lambda_handler
        code: bazel-bin/app/src/ingestion/event_pipes/dead_letter/data_contract_lambda_dead_letter.zip
        enable_otel_tracing: False
      app_config:
        deployment:
          configuration_version: "1"
        hosted_configuration:
            content:
      sqs: &sqs
        queue_name: &sqs_queue_name test-sqs-dead-letter
        encryption_key: NULL
      source_iam:
        role_name: source-endpoint-test
        assumed_by: !!python/object/apply:aws_cdk.aws_iam.ServicePrincipal
          - messaging.us-east-1.amazonaws.com
        description: IAM Role to be used for the secrets manager for test mariadb      
      target_iam:
        role_name: target-endpoint-test
        assumed_by: !!python/object/apply:aws_cdk.aws_iam.ServicePrincipal
          - messaging.amazonaws.com
        description: IAM Role to be used for the messaging target endpoint for test
      target_endpoint:
        endpoint_type: target
        engine_name: kinesis
      data_pipe:
        default_router_database: DEFAULT_ROUTER_DATABASE_LANDING
        metrics:
          error:
              namespace: event_pipes_validation_errors
              value: 1
              unit: Count
      source_kms_key: b502d39f-5276-4554-8b42-2c841a52e3a5 # Update for the secrets_manager_secret_id kms key
      source_ssl_cert: test-cert
